!function($){wp.media.controller.smnCategoryImageCropper=wp.media.controller.Cropper.extend({activate:function(){this.frame.on("content:create:crop",this.createCropContent,this),this.frame.on("close",this.removeCropper,this),this.set("selection",new Backbone.Collection(this.frame._selection.single))},createCropContent:function(){this.cropperView=new wp.media.view.smnCategoryImageCropper({controller:this,attachment:this.get("selection").first()}),this.cropperView.on("image-loaded",this.createCropToolbar,this),this.frame.content.set(this.cropperView)},doCrop:function(e){var t=e.get("cropDetails"),i=this.get("control"),a=!1;return t.dst_width=i.params.width,t.dst_height=i.params.height,campusAdminParams.maskEnabled&&"undefined"!=campusAdminParams.mask[campusAdminParams.categoryParentInput.val()]&&(a=campusAdminParams.mask[campusAdminParams.categoryParentInput.val()]),wp.ajax.post("smn_crop_image",{nonce:e.get("nonces").edit,id:e.get("id"),term_id:i.params.term_id,mask:a,context:i.id,cropDetails:t})}}),wp.media.view.smnCategoryImageCropper=wp.media.view.Cropper.extend({className:"crop-content smn-category-image",ready:function(){wp.media.view.Cropper.prototype.ready.apply(this,arguments),this.$(".crop-image").on("load",_.bind(this.onCropAreaLoad,this))},onCropAreaLoad:function(){this.controller.imgSelect.setOptions({onInit:this.setAspectRatio,onSelectChange:this.setAspectRatio});var e=".smn-category-image .media-sidebar { display: none;}";campusAdminParams.maskEnabled&&void 0!==campusAdminParams.mask[campusAdminParams.categoryParentInput.val()]&&(e+=".smn-category-image .imgareaselect-selection { background-image: url("+campusAdminParams.mask[campusAdminParams.categoryParentInput.val()]+"); background-size: cover; }"),$("#smn-category-image-preview-css").remove(),$("head").append('<style id="smn-category-image-preview-css" type="text/css">'+e+"</style>")},setAspectRatio:function(){}});var e,t,i,a,s,n,m,r;campusAdminParams.maskEnabled=!0,campusAdminParams.categoryParentInput=$("#parent");var o=function(r){if(a=r,t=a.find(".upload-custom-img"),i=a.find(".delete-custom-img"),s=a.find(".custom-img-container"),n=a.find(".custom-img-id"),m=a.find(".toggle-input"),e)return void e.open();e=wp.media({title:campusAdminText.title,button:{text:campusAdminText.choose_file},multiple:!1}),e.on("select",function(){var a=e.state().get("selection").first().toJSON();s.html('<img src="'+a.url+'" class="upload-custom-img" />'),n.val(a.id),t.add(m).addClass("hidden"),i.removeClass("hidden")}),e.open()},p={params:campusAdminParams.media,openFrame:function(e){if(this.id="category_thumbnail",this.cropper=e,this.addImgLink=this.cropper.find(".upload-custom-img"),this.delImgLink=this.cropper.find(".delete-custom-img"),this.imgContainer=this.cropper.find(".custom-img-container"),this.imgIdInput=this.cropper.find(".custom-img-id"),this.toggleInputs=this.cropper.find(".toggle-input"),this.params.term_id=$('input[name="tag_ID"]').val(),this.frame)return void this.frame.setState("library").open();this.initFrame(),this.frame.setState("library").open()},initFrame:function(){var e=_wpMediaViewsL10n;this.frame=wp.media({button:{text:e.select,close:!1},states:[new wp.media.controller.Library({title:campusAdminText.title,library:wp.media.query({type:"image"}),multiple:!1,date:!1,priority:20,suggestedWidth:this.params.width,suggestedHeight:this.params.height}),new wp.media.controller.smnCategoryImageCropper({imgSelectOptions:this.calculateImageSelectOptions,control:this})]}),this.frame.on("select",this.onSelect,this),this.frame.on("cropped",this.onCropped,this),this.frame.on("skippedcrop",this.onSkippedCrop,this)},onSelect:function(){var e=this.frame.state().get("selection").first().toJSON();new RegExp("category-").test(e.filename)?new RegExp("category-"+this.params.term_id).test(e.filename)?(this.setImageFromAttachment(e),this.frame.close()):alert("Cette image appartient à une autre catégorie !"):this.frame.setState("cropper")},onCropped:function(e){this.setImageFromAttachment(e)},calculateImageSelectOptions:function(e,t){var i=t.get("control"),a=!!parseInt(i.params.flex_width,10),s=!!parseInt(i.params.flex_height,10),n=e.get("width"),m=e.get("height"),r=parseInt(i.params.width,10),o=parseInt(i.params.height,10),p=r/o,c=r,d=o,l,g,h;return t.set("canSkipCrop",!1),n/m>p?(o=m,r=o*p):(r=n,o=r/p),l=(n-r)/2,g=(m-o)/2,h={handles:!0,keys:!0,instance:!0,persistent:!0,imageWidth:n,imageHeight:m,minWidth:c>r?r:c,minHeight:d>o?o:d,x1:l,y1:g,x2:r+l,y2:o+g},!1===s&&!1===a&&(h.aspectRatio=r+":"+o),!0===s&&(delete h.minHeight,h.maxWidth=n),!0===a&&(delete h.minWidth,h.maxHeight=m),h},mustBeCropped:function(e,t,i,a,s,n){return(!0!==e||!0!==t)&&((!0!==e||a!==n)&&((!0!==t||i!==s)&&((i!==s||a!==n)&&!(s<=i))))},onSkippedCrop:function(){var e=this.frame.state().get("selection").first().toJSON();this.setImageFromAttachment(e)},setImageFromAttachment:function(e){this.params.attachment=e,this.imgContainer.html('<img src="'+e.url+'" class="upload-custom-img" />'),this.imgIdInput.val(e.id),this.addImgLink.add(this.toggleInputs).addClass("hidden"),this.delImgLink.removeClass("hidden")}};$("#campus-toggle-media-cropper").on("click",function(){$(".campus-media-container").toggleClass("campus-media-cropper campus-media-uploader")}),$("#campus-toggle-media-cropper-mask").on("click",function(){campusAdminParams.maskEnabled=!campusAdminParams.maskEnabled}),$(".campus-media-container .upload-custom-img").on("click",function(e){e.preventDefault();var t=$(this).parents(".campus-media-container");t.hasClass("campus-media-cropper")?p.openFrame(t):o(t)}),$(".delete-custom-img").on("click",function(e){a=$(this).parents(".campus-media-container"),t=a.find(".upload-custom-img"),i=a.find(".delete-custom-img"),s=a.find(".custom-img-container"),n=a.find(".custom-img-id"),m=a.find(".toggle-input"),r=$('[name="podcast_thumbnail_id"]'),e.preventDefault(),s.find("img.upload-custom-img").remove(),t.add(m).removeClass("hidden"),i.addClass("hidden"),n.val(""),r.length&&(r.siblings(".custom-img-container").find("img").remove(),r.val(""))})}(jQuery);